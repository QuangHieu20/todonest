name: "Deploy code to production"
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ============= Build ===============
  build:
    name: Build
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Backend
        run: |
          cd be
          docker build -f ../.docker/be/Dockerfile -t todo-be:latest . || { echo "Backend build failed"; exit 1; }

      - name: Build Frontend
        run: |
          cd fe
          docker build -f ../.docker/fe/Dockerfile -t todo-fe:latest . || { echo "Frontend build failed"; exit 1; }

      - name: âœ… Build Test Completed
        run: echo "Build test completed successfully!"

  # ============= Deploy ===============
  deploy:
    name: Deploy to Production
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Deploy
        run: |
          echo "ğŸ“¥ Code already checked out..."
          
          # Stop existing containers
          echo "â¹ï¸ Stopping existing containers..."
          docker-compose -f docker-compose.yml down || true
          
          # Remove old images to save space
          echo "ğŸ§¹ Cleaning old images..."
          docker image prune -f || true
          
          # Build and start with production environment
          echo "ğŸš€ Building and starting containers..."
          docker-compose -f docker-compose.yml build --no-cache || { echo "Docker build failed"; exit 1; }
          docker-compose -f docker-compose.yml up -d || { echo "Docker up failed"; exit 1; }
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          sleep 30
          
          # Check if containers are running
          if ! docker-compose -f docker-compose.yml ps | grep -q "Up"; then
            echo "âŒ Containers are not running properly"
            docker-compose -f docker-compose.yml logs
            exit 1
          fi
          
          # Try health check on frontend port
          if curl -f http://localhost:3000/ > /dev/null 2>&1; then
            echo "âœ… Frontend health check passed"
          else
            echo "âš ï¸ Frontend health check failed, but continuing..."
          fi
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Frontend: https://todonest.id.vn"
          echo "ğŸŒ Backend API: https://todonest.id.vn/api"
